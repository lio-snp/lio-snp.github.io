---
interface Props {
  id: string;
  code: string;
}

const { id, code } = Astro.props;
---

<pre id={id} data-mermaid-block style="overflow:auto;"><code>{code}</code></pre>

<script>
  import mermaid from 'mermaid';

  const renderMermaidBlocks = async () => {
    const blocks = document.querySelectorAll('[data-mermaid-block]');
    if (blocks.length === 0) return;

    mermaid.initialize({ startOnLoad: false, theme: 'default' });

    for (const block of blocks) {
      if (block.dataset.mermaidRendered === 'true') continue;
      const code = block.querySelector('code')?.textContent || '';
      const blockId = block.id || `mermaid-${Math.random().toString(36).slice(2, 9)}`;

      try {
        const { svg } = await mermaid.render(blockId, code);
        block.outerHTML = svg;
      } catch (error) {
        block.innerHTML = '<code>Mermaid chart failed to render.</code>';
      }
    }
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      renderMermaidBlocks();
    }, { once: true });
  } else {
    renderMermaidBlocks();
  }
</script>
